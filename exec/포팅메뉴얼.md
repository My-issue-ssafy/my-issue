# 📌 개발 환경

---

**Mobile**

- **Android Compose**
    - Gradle: **`8.11.1`**
    - Android Gradle Plugin (AGP): **`8.10.1`**
    - Kotlin: **`2.1.21`**
    - Java (sourceCompatibility & targetCompatibility) : **`11`**
- **Android SDK**
    - compileSdk: **`36`**
    - targetSdk: **`35`**
    - minSdk: **`26`**
- **AndroidX & Compose**
    - Compose BOM: **`2024.09.00`**
    - Core KTX: **`1.16.0`**
    - Activity Compose: **`1.10.1`**
    - Lifecycle Runtime: **`2.9.2`**
- **의존성 주입 & 아키텍처**
    - Hilt: **`2.51`**
    - ViewModel: **`2.9.2`**
    - Navigation3: `1.0.0-alpha06`
- **네트워크 & 비동기**
    - Retrofit: **`2.11.0`**
    - OkHttp: **`4.12.0`**
    - Coroutines: **`1.8.1`**
- **데이터 저장**
    - datastore: `1.1.7`
- **Firebase & Google Services**
    - Google Services Plugin: **`4.4.3`**
- **미디어**
    - Media3: **`1.8.0`**
- **기타**
    - Coil (이미지 로딩): **`2.7.0`**
- **테스트**
    - JUnit: **`4.13.2`**
    - AndroidX JUnit: **`1.2.1`**
    - Espresso: **`3.6.1`**

```kotlin
agp = "8.10.1"
coilCompose = "2.7.0"
converterKotlinxSerialization = "3.0.0"
coreSplashscreen = "1.0.1"
desugar_jdk_libs = "2.0.4"
firebaseBom = "34.2.0"
hiltAndroid = "2.56.2"
hiltNavigationCompose = "1.2.0"
kotlin = "2.1.21"
coreKtx = "1.17.0"
junit = "4.13.2"
junitVersion = "1.3.0"
espressoCore = "3.7.0"
kotlinxCoroutinesGuava = "1.10.2"
kotlinxSerializationJson = "1.9.0"
lifecycleRuntimeKtx = "2.9.3"
activityCompose = "1.10.1"
	composeBom = "2024.09.00"
ksp = "2.1.21-2.0.2"
hilt = "2.56.2"
media3 = "1.8.0"
okhttp = "5.1.0"
retrofit = "3.0.0"
uiText = "1.9.0"
navigation3Runtime = "1.0.0-alpha06"
lifecycleViewmodelNavigation3Android = "1.0.0-alpha04"
datastorePreferences = "1.1.7"
googleServices = "4.4.3"
uiGraphics = "1.9.0"
foundationLayout = "1.9.0"
appcompat = "1.7.1"
```

**BackEnd**

- **Java**
    - Java OpenJDK  **`21`**
    - Gradle **`8.10`**
- **Spring Boot** **`3.4.9`**
    - Spring Web (MVC) **`3.4.9`**
    - Spring Data JPA **`3.4.9`**
    - Spring Data Redis **`3.4.9`**
    - Spring Data Elasticsearch **`5.1.0`**
    - Spring Security **`6.4.9`**
    - Spring Boot Actuator **`3.4.9`**
    - Spring Boot Validation **`3.4.9`**
- **ORM & Query**
    - QueryDSL **`5.1.0 (jakarta)`**
- **API & Docs**
    - Springdoc OpenAPI (Swagger UI) **`2.8.13`**
- **Authentication & Authorization**
    - JWT (JJWT) **`0.11.5`**
- **Cloud & Infra**
    - Spring Cloud AWS (S3) **`2.2.6`**
- **Messaging / Notification**
    - Firebase Admin SDK (FCM) **`9.4.3`**
- **Database**
    - PostgreSQL Driver **`42.x`**
- **Code Generation & Utilities**
    - Lombok **`1.18.x`**

- **Python**
    - Python **`3.11.9`**
- **AI**
    - **Text-to-Speech (TTS)**
        - Coqui TTS **`0.22.0`**
        - Microsoft Edge TTS **`6.1.0+`**
    - **Natural Language Processing**
        - Sentence Transformers **`3.0.1`**
        - Transformers **`4.21.0+`**
        - SentencePiece **`0.2.0+`**
    - **Machine Learning**
        - PyTorch **`2.0.0+`**
        - NumPy **`1.24.0+`**
        - SciPy **`1.10.0+`**
    - **Recommendation System**
        - Collaborative Filtering (Implicit) **`0.7.0+`**
        - Content-Based Filtering (Custom)
        - Hybrid Recommendation Engine
    - **Data Processing**
        - Pandas `1.4+`
        - PyArrow `15.0.0+`
        - Librosa 0.10.1 (Audio processing)

**UI/UX**

- Figma
- Canva

**IDE**

- IntelliJ **`2024-01`**
- Android Studio Meerkat **`2024.3.2`**
- VSCode **`1.104.2`**

**DB**

- PostgreSQL **`15.4`**
- redis **`7.4.5`**

**Search Engine**

- ElasticSearch **`8.17.2`**

**Server 배포 환경** 

- AWS EC2 **`Ubuntu 22.04.5 LTS`**
- Docker **`27.5.1`**
- Docker Hub

**CI/CD**

- Jenkins

**Collaboration**

 **형상관리** 

- GitLab

 **커뮤니케이션** 

- Mattermost
- Notion

 **이슈관리** 

- Jira

---

### **[Mobile]**

없음

### [BackEnd]

> **application.yaml**
> 

```bash
spring:
  application:
    name: my-issue
  config:
    import: optional:file:.env[.properties]
  datasource:
    url: ${SPRING_DATASOURCE_URL}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true # SQL 쿼리 로그 출력
  data:
    redis:
      host: j13d101.p.ssafy.io
      port: 6379
      password: ${REDIS_PASSWORD}
  task:
    scheduling:
      pool:
        size: 4
      thread-name-prefix: scheduling-
  elasticsearch:
    uris: ${ES_URI}
    username: ${ES_USERNAME}
    password: ${ES_PASSWORD}

# Spring Boot Actuator configuration ( Jenkins 에서 접근 가능하도록 설정 )
# health: 시스템 상태 확인(헬스체크용)
# info: 애플리케이션 정보 제공(git 커밋 정보 등)
management:
  endpoints:
    web:
      exposure:
        include: health, info, mappings, beans

springdoc:
  swagger-ui:
    enabled: true
    path: /swagger-ui
  api-docs:
    path: /v3/api-docs

logging:
  level:
    org:
      springframework:
        security: DEBUG
    com:
      ssafy:
        myissue: DEBUG

jwt:
  secret-base64: ${JWT_SECRET_BASE64}

cloud:
  aws:
    s3:
      bucket: venture-review   # 네가 만든 버킷 이름
    region:
      static: ap-northeast-2 # 서울
    stack:
      auto: false
    credentials:
      access-key: ${AWS_ACCESS_KEY}
      secret-key: ${AWS_SECRET_KEY}

gms:
  key: ${GMS_KEY}

openai:
  api-key: ${OPENAI_API_KEY}

app:
  recommend:
    url: ${APP_RECOMMEND_BASE_URL}
    params: ${APP_RECOMMEND_DEFAULT_PARAMS}

fcm:
  fire_path: /app/config/myissue-firebase.json
  project-id: myssue-7e186
#  fire_path: ${FIREBASE_PATH}
#  project-id: ${PROJECT_ID}
```

> **python server(fastapi) - 📃 requirement.txt**
> 

```bash
fastapi==0.115.0
uvicorn[standard]==0.30.6
requests==2.32.3
beautifulsoup4==4.12.3
lxml==5.2.2
SQLAlchemy==2.0.36
psycopg2-binary==2.9.9
sentence-transformers==3.0.1
transformers>=4.21.0
apscheduler==3.10.4

google-cloud-bigquery>=3.36.0
google-cloud-bigquery-storage>=2.26.0
google-auth>=2.40.0
db-dtypes>=1.0.0

pandas>=1.4,<2.0
pyarrow>=15.0.0
python-dateutil>=2.9.0

# Collaborative filtering model packages
numpy>=1.24.0
scipy>=1.10.0
implicit>=0.7.0
psutil>=5.9.0

torch>=2.0.0
pgvector==0.2.5
sentencepiece>=0.2.0
protobuf>=3.20.0
pydantic>=2.0
pydantic-settings>=2.0

# TTS packages
edge-tts>=6.1.0
TTS==0.22.0
torchaudio>=2.1.1
python-multipart==0.0.6
aiofiles==23.2.0
librosa==0.10.1
soundfile==0.12.1
loguru==0.7.3
pydub>=0.25.1

```

```jsx
!pip install -r requirement.txt
```

# 📌 배포 환경 설정

---

## 0. 초기 세팅

1. EC2 접속
    
    ```powershell
    **ssh -i J13D101T.pem ubuntu@j13d101.p.ssafy.io**
    ```
    
2. Docker & Docker Engine  설치
3. Jenkins 설치 및 연동

## 1. Docker 컨테이너 생성

- 백엔드
    - Spring Boot
    - FastAPI
- DB
    - Redis
    - PostgreSQL
- 검색 & 분석
    - Elasticsearch
    - Kibana
- 운영도구
    - Jenkins
    - PgAdmin4
- `docker ps` 결과
    
    ```bash
    $ docker ps
    CONTAINER ID   IMAGE                                      PORTS
    65b2f2463049   xioz19/my-issue:manual                      0.0.0.0:8083->8080/tcp
    c5d2a345c0d4   xioz19/my-issue-py:manual                   0.0.0.0:8085->8085/tcp
    2afdf015d2e5   docker.elastic.co/elasticsearch:8.17.2     0.0.0.0:9200->9200/tcp
    0a2802bc25e9   kibana:8.17.2                               0.0.0.0:5601->5601/tcp
    25b3f627d521   redis:7-alpine                              0.0.0.0:6379->6379/tcp
    7275b75ac1a6   ankame/pgvector                              0.0.0.0:5432->5432/tcp
    7021alb7d358   jenkins/jenkins:lts                          0.0.0.0:50000->50000/tcp
    f46fe9646bd0   dpage/pgadmin4                               0.0.0.0:8080->80/tcp
    ```
    

### PostgreSQL

```bash
docker run -d \
--name myissue-postgres \
--network myissue-network \
-e POSTGRES_USER=ssafy \
-e POSTGRES_PASSWORD=ssafy \
-e POSTGRES_DB=myissue \
-p 5432:5432 \
ankame/pgvector:latest
```

### Redis

```bash
docker run -d \
--name myissue-redis \
--network myissue-network \
-p 6379:6379 \
redis:7-alpine
```

- 컨테이너 접속
    
    $ `sudo docker exec -it [컨테이너 이름] bash`
    

## 2.  Jenkins 설정

### 📃  Jenkins 파이프라인

- **브랜치**
    - `dev/server` → Spring Boot
    - `dev/data` → FastAPI
- **자동화 흐름**
    - **GitLab Webhook → Jenkins Build → Docker Build & Push → Blue/Green Deploy**

### **🔑 Credential 관리**

빌드에 필요한 env 파일들을 저장해두고 배포 시 파일을 옮겨 서버에 올린다.

![image.png](attachment:230f0a4c-e704-4df9-983f-4502a338b919:image.png)

- **GitLab** : 소스코드 저장소 접근용
    - **`gitlab-creds`** : GitLab 프로젝트 Clone 및 Webhook 인증
- **Docker Hub** : 빌드한 이미지를 Push / Pull 하기 위한 계정
    - **`dockerhub-creds`** : Docker Hub 아이디 / 비밀번호
- **데이터베이스** : Spring Boot 애플리케이션 DB 연결 설정
    - **`SPRING_DATASOURCE_URL`** : DB 접속 URL
    - **`SPRING_DATASOURCE_USERNAME`** : DB 사용자명
    - **`SPRING_DATASOURCE_PASSWORD`** : DB 비밀번호
- **인증 / 보안 키**
    - **`JWT_SECRET_BASE64`** : JWT 서명용 시크릿 키 (Base64 인코딩)
    - **`REDIS_PASSWORD`** : Redis 비밀번호
    - **`AWS_ACCESS_KEY`, `AWS_SECRET_KEY`** : AWS S3 접근 키
    - **`GMS_KEY`** : 내부 추천 API 호출용 키
    - **`OPENAI_API_KEY`** : OpenAI API Key
- **알림 / 메시지 서비스**
    - **`google-service-account`** : Firebase Admin SDK용 JSON Credential
    - **`FIREBASE_TOKEN`** : FCM 발송용 토큰
- **검색 / 분석 서비스**
    - **`ES_URI`** : Elasticsearch 접속 URI
    - **`ES_USERNAME`, `ES_PASSWORD`** : Elasticsearch 계정
- **네트워크 / Nginx 설정**
    - **`NGINX_HOST`**, **`NGINX_USER`**, **`NGINX_CONF`** : Nginx 리로드 및 설정용 계정/경로
- **추천 API 기본 파라미터**
    - **`APP_RECOMMEND_BASE_URL`** : 추천 API Base URL
    - **`APP_RECOMMEND_DEFAULT_PARAMS`** : 추천 API 기본 파라미터

## 3. Gitlab → Jenkins Webhook 설정

- develop 브랜치

## 4. 배포스크립트 및 Dockerfile

### [Backend - Spring]

**📃 배포 Script**

```bash
pipeline {
  agent any

  environment { // 전역 환경변수 정의
    IMAGE_REPO = 'xioz19/my-issue' // 빌드/푸시할 Docker 이미지 경로.
    COMMIT_SHA = 'manual' // 이미지에 버전 태그로 붙여서 이력 추적 가능
    NGINX_HOST = credentials('NGINX_HOST')
    NGINX_USER = credentials('NGINX_USER')
    NGINX_CONF = credentials('NGINX_CONF')
  }

  options {
    timestamps()
    gitLabConnection('my-issue')
  } // Output 로그에 타임스탬프 붙여줌

  // MR/Push 이벤트 수신
  triggers {
    gitlab (
      triggerOnPush: true,

      // 브랜치 필터
      branchFilterType: 'NameBasedFilter',
      includeBranchesSpec: 'dev/server',  // push 이벤트: 이 브랜치만

      // dev/server 브랜치에 대해서만 빌드 트리거
      targetBranchRegex: 'dev/server'
    )
  }

  stages {
    stage('Checkout') { // GitLab 에서 코드 가져옴
      steps {
        checkout scm

        script {
          // 브랜치/커밋 정보 세팅 및 로깅
          env.COMMIT_SHA = sh(returnStdout: true, script: 'git rev-parse --short=7 HEAD').trim()
          echo "BRANCH_NAME=${env.BRANCH_NAME}, GIT_BRANCH=${env.GIT_BRANCH}, COMMIT_SHA=${env.COMMIT_SHA}"

          gitlabBuilds(builds: [
            '01-Build & Test',
            '02-Docker Build',
            '03-Push to Docker Hub',
            '04-Deploy'
          ]) {
            echo "GitLab job names 등록 완료"
          }
        }
      }
    }

    stage('01-Build & Test') {
      steps {
        gitlabCommitStatus(name: '01-Build & Test') {
          dir('backend/my-issue') {
            sh './gradlew clean build -x test'
          }
        }
      }
    }

    stage('02-Docker Build') { // Docker BuildKit 활성화
      when {
        expression { env.BRANCH_NAME == 'dev/server' || env.GIT_BRANCH == 'origin/dev/server' }
      }
      steps {
        gitlabCommitStatus(name: '02-Docker Build') {
          sh '''
            echo "=== Docker Build (backend/my-issue) ==="
            export DOCKER_BUILDKIT=1
            # 이전 빌드 결과 캐시로 활용
            docker pull ${IMAGE_REPO}:latest || true

            docker build \
              --pull \
              --cache-from=${IMAGE_REPO}:latest \
              -f backend/my-issue/Dockerfile \
              -t ${IMAGE_REPO}:latest \
              -t ${IMAGE_REPO}:${COMMIT_SHA} \
              backend/my-issue
          '''
          // Dockerfile 경로 지정 -> 최신 태그로도 빌드 -> 커밋 SHA 태그로도 빌드
          // Docker 이미지 2개 태그로 빌더 (latest + 커밋 버전)
        }
      }
    }

    stage('03-Push to Docker Hub') {
      when {
        expression { env.BRANCH_NAME == 'dev/server' || env.GIT_BRANCH == 'origin/dev/server' }
      }
      steps {
        gitlabCommitStatus(name: '03-Push to Docker Hub') {
          withCredentials([usernamePassword( // Jenkins에 등록된 Docker Hub 크리덴셜 사용
            credentialsId: 'dockerhub-cred',
            usernameVariable: 'DOCKER_USER',
            passwordVariable: 'DOCKER_PASS'
          )]) { // Docker Hub 로그인/푸시/로그아웃
            sh '''
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
              docker push ${IMAGE_REPO}:${COMMIT_SHA}
              docker push ${IMAGE_REPO}:latest
              docker logout || true
            '''
          }
        }
      }
    }

    stage('04-Deploy') {
      when {
        expression { env.BRANCH_NAME == 'dev/server' || env.GIT_BRANCH == 'origin/dev/server' }
      }
      steps {
        gitlabCommitStatus(name: '04-Deploy') {
          withCredentials([
            string(credentialsId: 'SPRING_DATASOURCE_URL',      variable: 'SPRING_DATASOURCE_URL'),
            string(credentialsId: 'SPRING_DATASOURCE_USERNAME', variable: 'SPRING_DATASOURCE_USERNAME'),
            string(credentialsId: 'SPRING_DATASOURCE_PASSWORD', variable: 'SPRING_DATASOURCE_PASSWORD'),
            string(credentialsId: 'JWT_SECRET_BASE64', variable: 'JWT_SECRET_BASE64'),
            string(credentialsId: 'REDIS_PASSWORD', variable: 'REDIS_PASSWORD'),
            string(credentialsId: 'AWS_ACCESS_KEY', variable: 'AWS_ACCESS_KEY'),
            string(credentialsId: 'AWS_SECRET_KEY', variable: 'AWS_SECRET_KEY'),
            string(credentialsId: 'GMS_KEY', variable: 'GMS_KEY'),
            string(credentialsId: 'APP_RECOMMEND_BASE_URL', variable: 'APP_RECOMMEND_BASE_URL'),
            string(credentialsId: 'APP_RECOMMEND_DEFAULT_PARAMS', variable: 'APP_RECOMMEND_DEFAULT_PARAMS'),
            string(credentialsId: 'FIREBASE_TOKEN', variable: 'FIREBASE_TOKEN'),
            string(credentialsId: 'ES_URI', variable: 'ES_URI'),
            string(credentialsId: 'ES_USERNAME', variable: 'ES_USERNAME'),
            string(credentialsId: 'ES_PASSWORD', variable: 'ES_PASSWORD'),
            string(credentialsId: 'OPENAI_API_KEY', variable: 'OPENAI_API_KEY'),
            sshUserPrivateKey(
              credentialsId: 'ec2-ssh-key-pem',
              keyFileVariable: 'SSH_KEY',
              usernameVariable: 'SSH_USER'
            )
          ]) {
            sh '''
              echo "🚀 Start Deploying ${IMAGE_REPO}:${COMMIT_SHA}"

              # 원격 서버에 secrets 디렉토리 보장
              ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$NGINX_HOST "mkdir -p /home/$SSH_USER/secrets"

              # Firebase secrets 파일 생성 및 전송
              echo "$FIREBASE_TOKEN" > myissue-firebase.json
              scp -o StrictHostKeyChecking=no -i "$SSH_KEY" myissue-firebase.json $SSH_USER@$NGINX_HOST:/home/$SSH_USER/secrets/myissue-firebase.json
              rm -f myissue-firebase.json

              # 1. deploy.sh 원격 서버에 복사
              scp -o StrictHostKeyChecking=no -i "$SSH_KEY" scripts/deploy.sh $SSH_USER@$NGINX_HOST:/home/$SSH_USER/deploy.sh

              # 2. 원격 서버에서 권한 주기
              ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" $SSH_USER@$NGINX_HOST "chmod +x /home/$SSH_USER/deploy.sh"

              # 3. 원격 서버에서 환경변수 붙여 실행
              ssh -o StrictHostKeyChecking=no -i "$SSH_KEY" "$SSH_USER@$NGINX_HOST" "
                export SPRING_DATASOURCE_URL='$SPRING_DATASOURCE_URL' &&
                export SPRING_DATASOURCE_USERNAME='$SPRING_DATASOURCE_USERNAME' &&
                export SPRING_DATASOURCE_PASSWORD='$SPRING_DATASOURCE_PASSWORD' &&
                export JWT_SECRET_BASE64='$JWT_SECRET_BASE64' &&
                export REDIS_PASSWORD='$REDIS_PASSWORD' &&
                export AWS_ACCESS_KEY='$AWS_ACCESS_KEY' &&
                export AWS_SECRET_KEY='$AWS_SECRET_KEY' &&
                export GMS_KEY='$GMS_KEY' &&
                export APP_RECOMMEND_BASE_URL='$APP_RECOMMEND_BASE_URL' &&
                export APP_RECOMMEND_DEFAULT_PARAMS='$APP_RECOMMEND_DEFAULT_PARAMS' &&
                export ES_URI='$ES_URI' &&
                export ES_USERNAME='$ES_USERNAME' &&
                export ES_PASSWORD='$ES_PASSWORD' &&
                export OPENAI_API_KEY='$OPENAI_API_KEY' &&
                export SPRING_PROFILES_ACTIVE=prod &&
                sudo -E bash /home/ubuntu/deploy.sh ${COMMIT_SHA}
              "
            '''
          }
        }
      }
    }
  }

  // 빌드 성공/실패 후 처리
  post {
    success {
      script {
          def authorName = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
          def authorEmail = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
          mattermostSend(
            endpoint: 'https://meeting.ssafy.com/hooks/smhi3szhdirx8mggofg3hwgoxc',
            channel: 'D101-Webhook',
            color: 'good',
            message: "✅ 빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${authorName} (${authorEmail})\n(<${env.BUILD_URL}|Details>)"
          )
        }
        echo "✅ Pushed: ${IMAGE_REPO}:${COMMIT_SHA} & :latest"
        updateGitlabCommitStatus name: 'jenkins/overall', state: 'success'
    }
    failure {
      script {
          def authorName = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
          def authorEmail = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
          mattermostSend(
            endpoint: 'https://meeting.ssafy.com/hooks/smhi3szhdirx8mggofg3hwgoxc',
            channel: 'D101-Webhook',
            color: 'danger',
            message: "❌ 빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${authorName} (${authorEmail})\n(<${env.BUILD_URL}|Details>)"
          )
        }
        updateGitlabCommitStatus name: 'jenkins/overall', state: 'failed'
    }
    always  { sh 'docker image prune -f || true' }
  }

}

```

**📃 Dockerfile**

```bash
# ── Build stage : 애플리케이션 JAR 만드는 단계 ──
FROM gradle:8.9-jdk21 AS builder
WORKDIR /src
COPY . .
RUN chmod +x gradlew && ./gradlew clean bootJar --no-daemon

# ── Run stage : 빌드된 JAR 실행하는 단계 ──
# 1) Java 21 JRE 환경이 담긴 공식 이미지 사용
FROM eclipse-temurin:21-jre

# 2) 컨테이너 안의 작업 디렉토리
WORKDIR /app

# 타임존 환경 변수 설정 (서울)
ENV TZ=Asia/Seoul

# 3) 빌드된 JAR 파일 복사
COPY --from=builder /src/build/libs/*.jar app.jar

# 4) 외부에서 접근할 포트 (Spring Boot 기본 8080)
EXPOSE 8080

# 5) 컨테이너 시작 시 실행할 명령어
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### [AI - Python]

**📃 배포스크립트**

```bash
pipeline {
	agent any
  options { timestamps(); disableConcurrentBuilds(); gitLabConnection('my-issue') }

  environment {
	IMAGE_REPO = 'xioz19/my-issue-py'
	TAG = 'manual' // Checkout에서 커밋 SHA로 덮어씀
	DOCKER_BUILDKIT = '1' 
  }

  triggers {
		gitlab(
      triggerOnPush: true,
      branchFilterType: 'NameBasedFilter',
      includeBranchesSpec: 'dev/data'
    )
  }

  stages {
		stage('Checkout') {
			steps {
				gitlabCommitStatus(name: 'Checkout') {
					checkout scm
					script {
						env.TAG = sh(returnStdout: true, script: "bash -lc 'git rev-parse --short=7 HEAD'").trim()
						echo "COMMIT_SHA=${env.TAG}"
					}
				}
      }
    }

    stage('Docker Build & Push') {
			steps {
				gitlabCommitStatus(name: 'Docker Build & Push') {
					withCredentials([usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
						dir('ai/fastapi') {
							sh '''
								bash -lc '
									set -Eeuo pipefail
									docker build -t ${IMAGE_REPO}:${TAG} -t ${IMAGE_REPO}:latest .
									echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
									docker push ${IMAGE_REPO}:${TAG}
									docker push ${IMAGE_REPO}:latest
									docker logout || true
								'
							'''
						}
					}
				}
      }
    }

    stage('Deploy (Blue/Green)') {
			steps {
				gitlabCommitStatus(name: 'Deploy (Blue/Green)') {
					withCredentials([
						sshUserPrivateKey(credentialsId: 'ec2-ssh-key-pem', keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USER'),
						string(credentialsId: 'NGINX_HOST', variable: 'NGINX_HOST'),
						string(credentialsId: 'DATABASE_URL', variable: 'DATABASE_URL'),
						file(credentialsId: 'google-service-account', variable: 'GOOGLE_APPLICATION_CREDENTIALS')
					]) {
						sh '''
							bash -lc '
								set -Eeuo pipefail
								echo "🚀 Deploy Python ${IMAGE_REPO}:${TAG}"
								scp -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i "$SSH_KEY" scripts/deploy_python.sh "$SSH_USER@$NGINX_HOST:~/deploy_python.sh"

								# SA 파일 서버로 복사
								ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i "$SSH_KEY" "$SSH_USER@$NGINX_HOST" "sudo mkdir -p /opt/sa && sudo chown $SSH_USER /opt/sa"
								scp -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i "$SSH_KEY" "$GOOGLE_APPLICATION_CREDENTIALS" "$SSH_USER@$NGINX_HOST:/opt/sa/gcp.json"
								ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i "$SSH_KEY" "$SSH_USER@$NGINX_HOST" "sudo chmod 600 /opt/sa/gcp.json"

								# 배포 스크립트 실행
								ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i "$SSH_KEY" "$SSH_USER@$NGINX_HOST" "\
									export DATABASE_URL=$(printf %q \"$DATABASE_URL\"); \
									chmod +x ~/deploy_python.sh; \
									sudo --preserve-env=DATABASE_URL -E ~/deploy_python.sh ${TAG} \
								"
							'
						'''
					}
        }
      }
    }
  }

  post {
		success {
      script {
        def authorName = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
        def authorEmail = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
        mattermostSend(
          endpoint: 'https://meeting.ssafy.com/hooks/smhi3szhdirx8mggofg3hwgoxc',
          channel: 'D101-Webhook',
          color: 'good',
          message: "✅ 빌드 성공: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${authorName} (${authorEmail})\n(<${env.BUILD_URL}|Details>)"
        )
      }
			echo "✅ Deployed ${IMAGE_REPO}:${TAG}"
			updateGitlabCommitStatus name: 'Pipeline', state: 'success'
		}
		failure {
      script {
        def authorName = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
        def authorEmail = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
        mattermostSend(
          endpoint: 'https://meeting.ssafy.com/hooks/smhi3szhdirx8mggofg3hwgoxc',
          channel: 'D101-Webhook',
          color: 'danger',
          message: "❌ 빌드 실패: ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${authorName} (${authorEmail})\n(<${env.BUILD_URL}|Details>)"
        )
      }
			updateGitlabCommitStatus name: 'Pipeline', state: 'failed'
		}
    always  { sh "bash -lc 'docker image prune -f || true'" }
  }
}

```

**📃 Dockerfile**

```bash
# syntax=docker/dockerfile:1.6

FROM python:3.11-slim

# OpenMP 런타임(필수) + 표준 C++ 런타임
RUN apt-get update && \
    apt-get install -y --no-install-recommends libgomp1 libstdc++6 && \
    rm -rf /var/lib/apt/lists/*

# 실용 기본값
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TZ=Asia/Seoul

WORKDIR /app

# 종속성 설치
COPY requirements.txt .

# BuildKit 캐시 마운트로 pip wheel 캐시 재사용
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --no-cache-dir -r requirements.txt

# 앱 복사
COPY . .

# uvicorn 실행 (포트 8085)
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8085"]
```

## 5. 빌드 환경 변수 설정

### Mobile 환경변수

```kotlin
BASE_URL=http://j13d101.p.ssafy.io/
```

## 6. 참고:

- EC2내 파일구조

```bash
/home/ubuntu
 ├─ deploy.sh                 # Spring Blue/Green 배포 스크립트
 ├─ deploy_python.sh          # FastAPI Blue/Green 배포 스크립트
 ├─ fastapi/                  # Python 추천·TTS 서비스
 │   └─ app/...
 ├─ backend/
 │   └─ my-issue/             # Spring Boot 애플리케이션
 ├─ jenkins-data/             # Jenkins 설정·작업공간
 ├─ secrets/
 │   └─ myissue-firebase.json # Firebase Admin SDK JSON
 ├─ mydb_backup.sql           # PostgreSQL 백업
 └─ http_ca.crt               # Elasticsearch 인증서
```

- DB 백업 파일
    - [다운 링크](https://drive.google.com/file/d/1KD-iFPJb0Fz4SU3ERuvyfvVTSx29R7g2/view?usp=sharing)

## 라이브 시연 시나리오

“이제 마이슈 앱을 시연해 보겠습니다.

바쁜 현대인을 위한 숏 콘텐츠 기반 뉴스가 실제로 어떻게 제공되는지 함께 보시죠.”

---

## 1. 뉴스 피드 (HOT 뉴스 / 최신 뉴스)

- **화면 시연**: 앱 실행 → 메인 피드 진입
- **멘트**:
    
    “먼저 뉴스 피드입니다.
    
    사용자는 앱 진입 시 처음으로 HOT 뉴스와 맞춤 뉴스, 최신 뉴스를 확인할 수 있습니다.
    
    HOT 뉴스에서는 단순히 많이 본 기사만 노출되는 것이 아니라, 최근에 올라온 뉴스가 더 상단에 배치될 수 있도록 구현하으며,
    
    사용자의 뉴스 소비 패턴을 분석하고 뉴스를 점수화한 결과로 맞춤 뉴스를 제공합니다.
    

---

## 2. 뉴스 검색

- **화면 시연**: 검색창 열기 → 키워드 입력 → 카테고리 필터 선택
- **멘트**:
    
    “다음은 검색 기능입니다.
    
    엘라스틱서치를 도입해 기존 쌍LIKE 검색보다 훨씬 빠른 속도로 결과를 반환합니다.
    
    보시는 것처럼 검색어 입력 시 빠른 응답 속도로 결과가 나오고, 카테고리 필터링을 통해 원하는 분야만 골라서 볼 수 있습니다.”
    

---

## 3. 뉴스 상세

- **화면 시연**: 기사 상세 진입
- **멘트**:
    
    “뉴스를 클릭하면 기사 전문을 포함한 상세 정보를 확인할 수 있으며, 우측 상단의 버튼을 통해 뉴스를 스크랩 할 수 있습니다.
    
    이 과정에서 사용자의 뉴스 클릭, 스크롤 깊이, 체류 시간, 스크랩 등의 행동 데이터를 로깅하여 개인화 추천에 활용합니다.”
    
    ---
    

## 4. 챗봇

- **화면 시연**: 기사 상세 → 우측 하단 챗봇 클릭
- **멘트**:
    
    우측 하단의 챗봇 버튼을 클릭하여 기사에 관련된 내용으로 챗봇과 대화할 수 있습니다.
    
    “사용자는 챗봇과 대화를 통해 **기사 요약**, **핵심 키워드 설명 등** 기사와 관련된 내용을 질문할 수 있으며, 이를 통해, 사용자는 기사를 빠르게 이해할 수 있습니다.”
    

---

## 5. 네컷 뉴스

- **화면 시연**: 네컷만화 화면 열기 → 스와이프/탭 시연
- **멘트**:
    
    “숏 컨텐츠인, 네컷 뉴스입니다.
    
    날짜별 인기 기사에서 하루 10개의 네컷만화를 자동 생성하여 사용자는 빠르고 재미있게 뉴스 정보를 확인할 수 있습니다.
    
    뉴스 카드를 오른쪽 스와이프 시 ‘관심 있음’, 왼쪽은 ‘관심 없음’을 표시할 수 있습니다.
    
    탭하면 기사의 요약본을 빠르게 확인할 수 있고, 위로 스와이프하면 기사 상세 정보를 보여줍니다.
    
    뉴스 로깅과 마찬가지로 네컷 뉴스 카드에서도 사용자 액션을 로깅하여 개인화 추천에 활용합니다.”
    

---

## 6. 팟캐스트

- **화면 시연**: 팟캐스트 목록 → 재생 시작
- **멘트**:
    
    “다음 기능은 팟캐스트 뉴스입니다.
    
    네컷 뉴스와 마찬가지로, 날짜별 인기 기사 10개를 기반으로 하루에 10분 분량의 팟캐스트를 자동 생성합니다.
    
    캘린더를 통해 주별, 월별 팟캐스트 뉴스를 선택할 수 있습니다.
    
    플레이어를 클릭하면 전체 대본을 확인할 수 있으며 대본을 클릭하여 해당 위치로 이동할 수 있씁니다. 또한, 우측 상단 토글 버튼을 통해, 해당 팟캐스트의 키워드와 관련된 기사들을 보여줍니다.  
    
    두 명의 진행자가 기사를 대화 형식으로 풀어주기 때문에, 이동 중이나 작업 중에도 부담 없이 뉴스를 들을 수 있습니다.”
    

---

## 7. 알림

- **화면 시연**: 탑바 알림 화면 열기
- **멘트**:
    
    “마지막은 알림 기능으로, 매일 추천된 **맞춤 뉴스**를 받아볼 수 있습니다.
    
    알림 화면을 통해 추천 받은 뉴스 알림 기록을 확인할 수 있으며, 사용자가 앱을 직접 열지 않더라도, 백그라운드 알림을 통해 자신에게 필요한 뉴스를 추천해줍니다.
    

---

## 마무리

- **멘트**:
    
    “지금까지 마이슈의 핵심 기능들을 시연해 보았습니다. 이어서 ~로 넘어가겠습니다.